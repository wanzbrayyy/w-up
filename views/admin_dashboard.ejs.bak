<%- include('partials/header', { title: 'Admin Panel', pageCss: 'dashboard' }) %>

<div class="dashboard-layout">
    <main class="main-content" style="padding: 1.5rem; max-width: 1600px; margin: 0 auto;">
        
        <!-- Header Section -->
        <div class="admin-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; margin-bottom:2rem; padding-bottom:1rem; border-bottom:1px solid var(--border);">
            <div style="display:flex; align-items:center; gap:10px;">
                <h1 style="margin:0; font-size:1.5rem;"><i class="fa-solid fa-gauge-high"></i> Admin Console</h1>
            </div>
            <a href="/dashboard" class="btn secondary-btn"><i class="fa-solid fa-arrow-left"></i> Back to App</a>
        </div>

        <!-- Server Stats Grid -->
        <div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1rem; margin-bottom:2rem;">
            <!-- Server Load -->
            <div class="stat-card" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--muted-text); margin-bottom:0.5rem;">Server Health</h3>
                        <div style="font-weight:bold; font-size:1.1rem;"><%= serverStats.cores %> Cores / <%= (serverStats.memoryUsage || 0).toFixed(1) %> % RAM</div>
                        <div style="font-size:0.8rem; color:var(--muted-text); margin-top:5px;">Load: <%= (serverStats.load || 0).toFixed(2) %> &bull; Up: <%= (serverStats.uptime || 0).toFixed(1) %>h</div>
                    </div>
                    <i class="fa-solid fa-server" style="font-size:1.5rem; color:var(--primary); opacity:0.5;"></i>
                </div>
            </div>

            <!-- Total Users -->
            <div class="stat-card" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--muted-text); margin-bottom:0.5rem;">Total Users</h3>
                        <div style="font-size:1.8rem; font-weight:800;"><%= userCount %></div>
                    </div>
                    <i class="fa-solid fa-users" style="font-size:1.5rem; color:var(--primary); opacity:0.5;"></i>
                </div>
            </div>

            <!-- Total Files -->
            <div class="stat-card" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--muted-text); margin-bottom:0.5rem;">Total Files</h3>
                        <div style="font-size:1.8rem; font-weight:800;"><%= fileCount %></div>
                    </div>
                    <i class="fa-solid fa-file-invoice" style="font-size:1.5rem; color:var(--primary); opacity:0.5;"></i>
                </div>
            </div>

            <!-- Storage Used -->
            <div class="stat-card" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h3 style="font-size:0.85rem; text-transform:uppercase; color:var(--muted-text); margin-bottom:0.5rem;">Storage Used</h3>
                        <div style="font-size:1.8rem; font-weight:800;"><%= (totalSize / 1024 / 1024 / 1024).toFixed(2) %> GB</div>
                    </div>
                    <i class="fa-solid fa-hard-drive" style="font-size:1.5rem; color:var(--primary); opacity:0.5;"></i>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="admin-layout-grid" style="display: grid; gap: 2rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            
            <!-- LEFT COLUMN: User Management (Takes more width on desktop) -->
            <div class="col-main" style="grid-column: span 2; min-width: 0;"> 
                <section class="admin-section" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                    <h3 style="margin-bottom:1rem; font-size:1.1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem;">User Management</h3>
                    
                    <!-- Responsive Table Wrapper -->
                    <div style="overflow-x: auto;">
                        <table style="width:100%; border-collapse:collapse; white-space:nowrap;">
                            <thead>
                                <tr style="text-align:left; background:var(--bg-secondary);">
                                    <th style="padding:0.75rem;">Identity</th>
                                    <th style="padding:0.75rem;">Subscription & Limits</th>
                                    <th style="padding:0.75rem;">Status</th>
                                    <th style="padding:0.75rem; text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(u => { %>
                                    <tr style="border-bottom:1px solid var(--border);">
                                        <td style="padding:0.75rem;">
                                            <div style="display:flex; flex-direction:column;">
                                                <strong style="font-size:0.95rem;"><%= u.username %></strong>
                                                <small style="color:var(--muted-text);"><%= u.email || 'No Email' %></small>
                                                <% if(u.role === 'admin') { %> 
                                                    <span style="font-size:0.6rem; background:#1f2937; color:white; padding:2px 4px; border-radius:3px; width:fit-content; margin-top:2px;">ADMIN</span> 
                                                <% } %>
                                            </div>
                                        </td>
                                        <td style="padding:0.75rem;">
                                            <div style="display:flex; flex-direction:column; gap:5px;">
                                                <!-- Plan Selector -->
                                                <form action="/admin/users/<%= u._id %>/update" method="POST">
                                                    <input type="hidden" name="action" value="plan">
                                                    <select name="value" onchange="this.form.submit()" style="padding:4px; font-size:0.8rem; border-radius:4px; border:1px solid var(--border); background:var(--bg);">
                                                        <option value="free" <%= u.plan === 'free' ? 'selected' : '' %>>Free Plan</option>
                                                        <option value="pro" <%= u.plan === 'pro' ? 'selected' : '' %>>Pro Plan</option>
                                                    </select>
                                                </form>
                                                <!-- Bandwidth Limit -->
                                                <form action="/admin/users/<%= u._id %>/update" method="POST" style="display:flex; align-items:center; gap:5px;">
                                                    <input type="hidden" name="action" value="bandwidth">
                                                    <input type="number" name="value" value="<%= u.bandwidthLimit || 0 %>" placeholder="KB/s" style="width:70px; padding:3px; font-size:0.8rem; border:1px solid var(--border); border-radius:4px;">
                                                    <button title="Save Bandwidth" style="background:none; border:none; color:var(--primary); cursor:pointer;"><i class="fa-solid fa-floppy-disk"></i></button>
                                                </form>
                                            </div>
                                        </td>
                                        <td style="padding:0.75rem;">
                                            <% if(u.isBanned) { %> 
                                                <span style="color:#ef4444; font-weight:bold; font-size:0.8rem;"><i class="fa-solid fa-ban"></i> Banned</span> 
                                            <% } else { %> 
                                                <span style="color:#22c55e; font-size:0.8rem;"><i class="fa-solid fa-circle-check"></i> Active</span> 
                                            <% } %>
                                            <% if(u.isVerified) { %> 
                                                <div style="color:#3b82f6; font-size:0.75rem; margin-top:2px;"><i class="fa-solid fa-check-circle"></i> Verified</div> 
                                            <% } %>
                                        </td>
                                        <td style="padding:0.75rem; text-align:right;">
                                            <div style="display:flex; justify-content:flex-end; gap:5px;">
                                                <a href="/admin/impersonate/<%= u._id %>" class="btn secondary-btn" style="padding:0.4rem; font-size:0.8rem;" title="Login as this User">
                                                    <i class="fa-solid fa-mask"></i>
                                                </a>
                                                
                                                <% if(!u.isVerified) { %>
                                                    <form action="/admin/users/<%= u._id %>/update" method="POST" style="display:inline;">
                                                        <input type="hidden" name="action" value="verify">
                                                        <button class="btn secondary-btn" style="padding:0.4rem; font-size:0.8rem; color:#3b82f6;" title="Verify">
                                                            <i class="fa-solid fa-certificate"></i>
                                                        </button>
                                                    </form>
                                                <% } %>

                                                <% if(!u.isBanned) { %>
                                                    <form action="/admin/users/<%= u._id %>/update" method="POST" onsubmit="return confirm('Ban user?');" style="display:inline;">
                                                        <input type="hidden" name="action" value="ban">
                                                        <button class="btn danger-btn" style="padding:0.4rem; font-size:0.8rem;" title="Ban User">
                                                            <i class="fa-solid fa-gavel"></i>
                                                        </button>
                                                    </form>
                                                <% } else { %>
                                                    <form action="/admin/users/<%= u._id %>/update" method="POST" style="display:inline;">
                                                        <input type="hidden" name="action" value="unban">
                                                        <button class="btn primary-btn" style="padding:0.4rem; font-size:0.8rem;" title="Unban User">
                                                            <i class="fa-solid fa-lock-open"></i>
                                                        </button>
                                                    </form>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- RIGHT COLUMN: System & Money (Takes 1 column) -->
            <div class="col-sidebar" style="display:flex; flex-direction:column; gap:2rem;">
                
                <!-- Global Config -->
                <section class="admin-section" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                    <h3 style="margin-bottom:1rem; font-size:1.1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem;">System Configuration</h3>
                    <form action="/admin/config" method="POST" style="display:flex; flex-direction:column; gap:1rem;">
                        
                        <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center;">
                            <label style="font-weight:500;">Maintenance Mode</label>
                            <label class="switch">
                                <input type="checkbox" name="maintenanceMode" <%= config.maintenanceMode ? 'checked' : '' %>>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="toggle-row" style="display:flex; justify-content:space-between; align-items:center;">
                            <label style="font-weight:500;">Enable Ads</label>
                            <label class="switch">
                                <input type="checkbox" name="adsEnabled" <%= config.adsEnabled ? 'checked' : '' %>>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label style="display:block; font-size:0.85rem; color:var(--muted-text); margin-bottom:5px;">Global Announcement</label>
                            <input type="text" name="globalAnnouncement" class="full-input" value="<%= config.globalAnnouncement %>" placeholder="Alert message..." style="width:100%; padding:8px; border-radius:5px; border:1px solid var(--border); background:var(--bg);">
                        </div>

                        <div class="form-group">
                            <label style="display:block; font-size:0.85rem; color:var(--muted-text); margin-bottom:5px;">AdSense Script</label>
                            <textarea name="adScript" class="full-input" rows="3" style="width:100%; padding:8px; border-radius:5px; border:1px solid var(--border); background:var(--bg); font-family:monospace; font-size:0.8rem;"><%= config.adScript %></textarea>
                        </div>

                        <button type="submit" class="btn primary-btn" style="width:100%; padding:0.7rem;">Update Config</button>
                    </form>
                </section>

                <!-- Affiliate Payouts -->
                <section class="admin-section" style="background:var(--card); padding:1.5rem; border-radius:10px; border:1px solid var(--border);">
                    <h3 style="margin-bottom:1rem; font-size:1.1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem;">Pending Payouts</h3>
                    <div class="payout-list" style="display:flex; flex-direction:column; gap:0.8rem;">
                        <% if(topAffiliates.length > 0) { %>
                            <% topAffiliates.forEach(aff => { %>
                                <div class="payout-item" style="display:flex; justify-content:space-between; align-items:center; padding-bottom:0.8rem; border-bottom:1px dashed var(--border);">
                                    <div>
                                        <div style="font-weight:bold; font-size:0.9rem;"><%= aff.username %></div>
                                        <div style="font-size:0.8rem; color:var(--muted-text);"><%= aff.referralCount %> Refs</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-weight:bold; color:#16a34a; font-size:0.9rem;">$<%= (aff.walletBalance || 0).toFixed(2) %></div>
                                        <form action="/admin/payout/<%= aff._id %>" method="POST" onsubmit="return confirm('Confirm payout?');" style="margin-top:2px;">
                                            <button style="background:var(--bg-secondary); border:1px solid var(--border); cursor:pointer; font-size:0.7rem; padding:2px 6px; border-radius:4px;">Mark Paid</button>
                                        </form>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p style="color:var(--muted-text); font-size:0.9rem; text-align:center;">No pending payouts.</p>
                        <% } %>
                    </div>
                </section>

            </div>
        </div>
    </main>
</div>

<style>
    /* CSS Toggle Switch */
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* Responsive Handling for Admin Grid */
    @media (max-width: 1024px) {
        .admin-layout-grid {
            grid-template-columns: 1fr !important; /* Stack columns on tablet/mobile */
        }
        .col-main { grid-column: span 1 !important; }
    }
</style>

<%- include('partials/footer') %>