<%- include('partials/header', { title: 'Login', pageCss: 'auth' }) %>

<script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>

<main class="auth-container">
    <div class="auth-card">
        <h1 class="auth-title">Welcome Back</h1>
        <p class="auth-subtitle">Sign in with your passkey or password.</p>

        <div id="passkeySection">
            <button class="btn-passkey" id="passkeyLoginBtn">
                <i class="fa-solid fa-fingerprint"></i>
                <span>Sign in with Passkey</span>
            </button>
            <div class="divider">or</div>
        </div>

        <form id="passwordForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" class="form-input" required autocomplete="username webauthn">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" class="form-input" required autocomplete="current-password">
            </div>

            <div class="form-error" id="formError" style="display: none;"></div>

            <button type="submit" class="btn-submit">
                <i class="fa-solid fa-right-to-bracket"></i> Sign In with Password
            </button>
        </form>
        <div class="auth-switch">
            Don't have an account? <a href="/register">Sign Up</a>
        </div>
    </div>
</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const { startAuthentication } = SimpleWebAuthnBrowser;
    
    const passkeyBtn = document.getElementById('passkeyLoginBtn');
    const passwordForm = document.getElementById('passwordForm');
    const errorBox = document.getElementById('formError');

    const handleSuccess = () => {
        showToast('Login successful!', 'success');
        setTimeout(() => window.location.href = '/dashboard', 1000);
    };

    const handleError = (message) => {
        errorBox.textContent = message || 'An error occurred.';
        errorBox.style.display = 'block';
    };

    // Passkey Login Handler
    passkeyBtn.addEventListener('click', async () => {
        errorBox.style.display = 'none';
        try {
            const respOptions = await fetch('/api/auth/passkey/login-options', { method: 'POST' });
            if (!respOptions.ok) throw new Error('Could not get passkey options from server.');

            const options = await respOptions.json();
            const authResp = await startAuthentication(options);

            const verificationResp = await fetch('/api/auth/passkey/verify-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(authResp),
            });

            const verificationJSON = await verificationResp.json();
            if (verificationJSON && verificationJSON.verified) {
                handleSuccess();
            } else {
                throw new Error(verificationJSON.error || 'Passkey verification failed.');
            }
        } catch (error) {
            handleError(error.message);
        }
    });

    // Password Login Handler
    passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorBox.style.display = 'none';

        const username = e.target.username.value;
        const password = e.target.password.value;

        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (response.ok) {
                // Handle 2FA if required
                if (data.status === '2fa_required') {
                    const code = prompt('Please enter your 2FA code:');
                    if (code) {
                        const twoFaResponse = await fetch('/login/2fa', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code })
                        });
                        const twoFaData = await twoFaResponse.json();
                        if (twoFaResponse.ok) {
                            handleSuccess();
                        } else {
                            handleError(twoFaData.message);
                        }
                    }
                } else {
                    handleSuccess();
                }
            } else {
                handleError(data.message);
            }
        } catch (error) {
            handleError('A network error occurred.');
        }
    });
});
</script>

<%- include('partials/footer') %>