<%- include('partials/header', { title: `Download ${file.originalName}`, pageCss: 'download' }) %>

<main class="download-page-container">
    <div class="download-card">
        <div class="file-icon-wrapper">
            <% if (file.isFolder) { %>
                <i class="fa-solid fa-folder-open file-icon" style="color: #fbbf24;"></i>
            <% } else if (file.contentType.startsWith('image/')) { %>
                <i class="fa-solid fa-image file-icon"></i>
            <% } else if (file.contentType.startsWith('video/')) { %>
                <i class="fa-solid fa-video file-icon"></i>
            <% } else if (file.contentType.startsWith('audio/')) { %>
                <i class="fa-solid fa-music file-icon"></i>
            <% } else { %>
                <i class="fa-solid fa-file-arrow-down file-icon"></i>
            <% } %>
        </div>
        
        <h1 class="filename"><%= file.originalName %></h1>
        <div class="file-meta">
            <% if (file.isFolder) { %>
                Type: Folder Archive &bull; 
            <% } else { %>
                Size: <%= (file.size / 1024 / 1024).toFixed(2) %> MB &bull; 
            <% } %>
            Uploaded: <%= new Date(file.createdAt).toLocaleDateString() %> &bull;
            Downloads: <%= file.downloads %>
        </div>

        <div class="preview-area" style="display: block; margin-bottom: 2rem;">
            <% if (!file.isFolder) { %>
                <% if (file.contentType.startsWith('image/')) { %>
                    <img src="<%= downloadLink %>" alt="Preview" class="preview-content" style="max-width: 100%; border-radius: 8px;">
                <% } else if (file.contentType.startsWith('video/')) { %>
                    <video controls class="preview-content" style="max-width: 100%; border-radius: 8px;">
                        <source src="<%= downloadLink %>" type="<%= file.contentType %>">
                        Your browser does not support the video tag.
                    </video>
                <% } else if (file.contentType.startsWith('audio/')) { %>
                    <audio controls class="preview-content" style="width: 100%; margin-top: 1rem;">
                        <source src="<%= downloadLink %>" type="<%= file.contentType %>">
                        Your browser does not support the audio element.
                    </audio>
                <% } %>
            <% } %>
        </div>

        <% if (file.isBurnAfterRead) { %>
            <div class="alert-box warning"><i class="fa-solid fa-fire"></i> This file will self-destruct after you download it!</div>
        <% } %>

        <a href="<%= downloadLink %>" class="btn-download" id="downloadLinkBtn" <%= file.isFolder ? '' : 'download' %>>
            <% if (file.isFolder) { %>
                <i class="fa-solid fa-file-zipper"></i> Download Folder as ZIP
            <% } else { %>
                <i class="fa-solid fa-download"></i> Download File
            <% } %>
        </a>

        <div class="share-buttons">
            <span>Share:</span>
            <a href="https://wa.me/?text=Download <%= file.originalName %> here: <%= downloadLink %>" target="_blank" class="share-btn whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
            <a href="https://twitter.com/intent/tweet?text=Check out this file&url=<%= downloadLink %>" target="_blank" class="share-btn twitter"><i class="fa-brands fa-twitter"></i></a>
            <button onclick="navigator.clipboard.writeText(window.location.href); showToast('Link copied!')" class="share-btn copy"><i class="fa-solid fa-link"></i></button>
        </div>

        <div class="reactions">
            <button class="react-btn" onclick="react('like')">
                <i class="fa-solid fa-thumbs-up"></i> <span id="likeCount"><%= file.reactions?.like?.length || 0 %></span>
            </button>
            <button class="react-btn" onclick="react('love')">
                <i class="fa-solid fa-heart"></i> <span id="loveCount"><%= file.reactions?.love?.length || 0 %></span>
            </button>
        </div>

        <div class="report-section">
            <button id="reportBtn" class="report-link">Report this file</button>
        </div>
    </div>

    <div class="comments-section">
        <h3>Comments</h3>
        <div class="comment-list" id="commentList">
            <% if(file.comments && file.comments.length > 0) { %>
                <% file.comments.forEach(c => { %>
                    <div class="comment">
                        <strong><%= c.username %></strong>
                        <p><%= c.text %></p>
                        <small><%= new Date(c.createdAt).toLocaleDateString() %></small>
                    </div>
                <% }) %>
            <% } else { %>
                <p style="color: var(--muted-text); text-align: center;">No comments yet.</p>
            <% } %>
        </div>
        <% if (isLoggedIn) { %>
            <form id="commentForm">
                <input type="text" name="text" placeholder="Write a comment..." required>
                <button type="submit">Post</button>
            </form>
        <% } else { %>
            <p style="text-align:center;"><a href="/login">Login</a> to comment.</p>
        <% } %>
    </div>
</main>

<div class="modal-backdrop" id="reportModal">
    <div class="modal-content">
        <div class="modal-header"><h3>Report File</h3><button class="modal-close">&times;</button></div>
        <form id="reportForm">
            <div class="modal-form-group">
                <label>Category</label>
                <select name="category" class="modal-input">
                    <option>Copyright Violation</option>
                    <option>Malware/Virus</option>
                    <option>Inappropriate Content</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label>Reason</label>
                <textarea name="reason" class="modal-input" rows="3" required></textarea>
            </div>
            <button type="submit" class="action-btn" style="width:100%; background: #ef4444; color: white;">Submit Report</button>
        </form>
    </div>
</div>

<script>
    const reportModal = document.getElementById('reportModal');
    document.getElementById('reportBtn').addEventListener('click', () => reportModal.classList.add('active'));
    reportModal.querySelector('.modal-close').addEventListener('click', () => reportModal.classList.remove('active'));

    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target));
        const res = await fetch('/api/report/<%= file.customAlias %>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        if (res.ok) { showToast('Report submitted.', 'success'); reportModal.classList.remove('active'); }
    });

    async function react(type) {
        const res = await fetch('/api/files/<%= file.customAlias %>/react', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type})
        });
        const data = await res.json();
        if(res.ok) {
            document.getElementById('likeCount').textContent = data.counts.like;
            document.getElementById('loveCount').textContent = data.counts.love;
        }
    }

    const commentForm = document.getElementById('commentForm');
    if(commentForm) {
        commentForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const text = e.target.text.value;
            const res = await fetch('/api/files/<%= file.customAlias %>/comment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });
            if(res.ok) location.reload();
        });
    }
</script>

<%- include('partials/footer') %>