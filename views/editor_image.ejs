<%- include('partials/header', { title: 'Image Editor' }) %>
<link rel="stylesheet" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css">
<style>
    body { background: #1a1a1a; } 
    .tui-image-editor-container { margin: 20px auto; }
    .top-bar-controls { position:fixed; top:20px; right:20px; z-index:10; display:flex; gap:10px; }
</style>

<div class="top-bar-controls">
    <button id="annotateBtn" class="btn secondary-btn">Add Note</button>
    <button id="saveBtn" class="btn primary-btn">Save Changes</button>
</div>
<div id="tui-image-editor-container"></div>

<script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.js"></script>
<script>
    const imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
        includeUI: {
            loadImage: { path: '/w-upload/raw/<%= file.customAlias %>', name: '<%= file.originalName %>' },
            theme: 'dark',
            menu: ['crop', 'flip', 'rotate', 'draw', 'shape', 'icon', 'text', 'mask', 'filter'],
            initMenu: 'filter',
            uiSize: { width: '100%', height: 'calc(100vh - 50px)' },
            menuBarPosition: 'bottom'
        },
        cssMaxWidth: 900,
        cssMaxHeight: 700,
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const base64 = imageEditor.toDataURL();
        const res = await fetch('/api/files/<%= file._id %>/save-version', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ base64 })
        });
        if (res.ok) alert('Saved!'); else alert('Failed!');
    });
    
    document.getElementById('annotateBtn').addEventListener('click', async () => {
        const text = prompt("Enter your annotation/comment:");
        if (!text) return;
        const data = { text, x: 100, y: 100 };
        await fetch('/api/files/<%= file._id %>/annotations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'comment', data })
        });
        alert('Note added (Proof of Concept)');
    });
</script>
<%- include('partials/footer') %>