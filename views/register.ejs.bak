<%- include('partials/header', { title: 'Create Account', pageCss: 'auth' }) %>

<main class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1 class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Join us and start sharing files securely.</p>
        </div>

        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-user input-icon"></i>
                    <input type="text" id="username" name="username" placeholder="Choose a unique username" required minlength="3" autocomplete="username">
                </div>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-lock input-icon"></i>
                    <input type="password" id="password" name="password" placeholder="Create a strong password" required minlength="6" autocomplete="new-password">
                </div>
                <div class="password-strength" id="pwdStrength"></div>
            </div>

            <div class="form-group">
                <label for="referralCode">Referral Code <span class="badge-optional">Optional</span></label>
                <div class="input-wrapper">
                    <i class="fa-solid fa-gift input-icon"></i>
                    <input type="text" id="referralCode" name="referralCode" placeholder="Enter code for bonus storage">
                </div>
            </div>

            <div class="form-error" id="formError" style="display: none;"></div>

            <button type="submit" class="btn-submit" id="submitBtn">
                <span>Sign Up</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </form>

        <div class="auth-footer">
            <p>Already have an account? <a href="/login">Sign In</a></p>
        </div>
    </div>
</main>

<style>
    /* Inline styles for specific Auth tweaks if main CSS is missing specifics */
    .input-wrapper { position: relative; }
    .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--muted-text); }
    .auth-form input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg); color: var(--text); transition: all 0.2s; }
    .auth-form input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); outline: none; }
    .badge-optional { font-size: 0.7rem; background: var(--bg-secondary); color: var(--muted-text); padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    .form-error { background: #fee2e2; color: #ef4444; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.9rem; text-align: center; border: 1px solid #fecaca; }
    .btn-submit:disabled { opacity: 0.7; cursor: not-allowed; }
</style>

<script>
    const form = document.getElementById('registerForm');
    const errorBox = document.getElementById('formError');
    const submitBtn = document.getElementById('submitBtn');

    // Auto-fill referral from URL query ?ref=CODE
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');
    if(refParam) document.getElementById('referralCode').value = refParam;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorBox.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

        const formData = {
            username: e.target.username.value,
            password: e.target.password.value,
            referralCode: e.target.referralCode.value
        };

        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();

            if (response.ok) {
                showToast('Registration successful! Redirecting...', 'success');
                setTimeout(() => window.location.href = '/login', 1500);
            } else {
                // Handle specific errors like Rate Limit (429)
                errorBox.textContent = data.message || 'Registration failed.';
                errorBox.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Sign Up</span> <i class="fa-solid fa-arrow-right"></i>';
            }
        } catch (error) {
            errorBox.textContent = 'Network error. Please try again.';
            errorBox.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Sign Up</span> <i class="fa-solid fa-arrow-right"></i>';
        }
    });
</script>

<%- include('partials/footer') %>