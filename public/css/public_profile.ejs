<%- include('partials/header', { title: targetUser.branding.pageTitle || targetUser.username }) %>

<style>
    :root {
        --branded-primary: <%= targetUser.branding.primaryColor || '#4F46E5' %>;
    }
    .profile-header {
        padding: 4rem 1rem 2rem 1rem;
        background: linear-gradient(180deg, rgba(0,0,0,0.05), transparent);
    }
    .profile-header .icon {
        font-size: 4rem;
        color: var(--branded-primary);
    }
    .upload-area {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 3rem 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg);
        max-width: 800px;
        margin: 2rem auto;
    }
    .upload-area:hover, .upload-area.drag-over {
        border-color: var(--branded-primary);
        background: rgba(79, 70, 229, 0.05);
    }
    .upload-placeholder strong {
        color: var(--branded-primary);
    }
</style>

<main class="dashboard-container" style="text-align: center;">
    <div class="profile-header">
        <% if (targetUser.branding.logoUrl) { %>
            <img src="<%= targetUser.branding.logoUrl %>" alt="Logo" style="max-height: 80px; margin-bottom: 1rem;">
        <% } else { %>
            <div class="icon"><i class="fa-solid fa-circle-user"></i></div>
        <% } %>
        <h1><%= targetUser.branding.pageTitle || targetUser.username %></h1>
        <p style="color: var(--muted-text);"><%= targetUser.publicBio || 'No bio available.' %></p>
    </div>

    <div class="upload-area" id="dropZone">
        <input type="file" id="fileInput" multiple hidden>
        <div class="upload-placeholder">
            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; color: var(--muted-text); margin-bottom: 1rem;"></i>
            <p><strong>Upload File</strong> atau seret & jatuhkan di sini</p>
        </div>
    </div>
    <div id="uploadList" style="max-width: 800px; margin: 1rem auto; display: flex; flex-direction: column; gap: 0.75rem;"></div>

    <h2 style="margin-top: 3rem; border-top: 1px solid var(--border); padding-top: 2rem;">File Publik</h2>
    <div class="file-grid">
        <% files.forEach(file => { %>
            <div class="file-card">
                <div class="file-preview">
                    <% if (file.contentType.startsWith('image/')) { %>
                        <i class="fa-solid fa-image"></i>
                    <% } else { %>
                        <i class="fa-solid fa-file"></i>
                    <% } %>
                </div>
                <div class="file-details">
                    <a href="/w-upload/file/<%= file.customAlias %>" class="filename"><%= file.originalName %></a>
                    <div class="meta"><%= (file.size / 1024 / 1024).toFixed(2) %> MB</div>
                </div>
            </div>
        <% }) %>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadList = document.getElementById('uploadList');
    const publicUsername = "<%= targetUser.username %>";

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', e => { handleFiles(e.target.files); fileInput.value = ''; });

    function handleFiles(files) {
        Array.from(files).forEach(uploadFile);
    }

    function createUploadItem(file) {
        const item = document.createElement('div');
        item.style = 'display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;';
        item.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i><div style="flex:1;min-width:0;"><div style="font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${file.name}</div><div class="status" style="font-size:0.8rem;">Uploading...</div></div>`;
        uploadList.prepend(item);
        return item;
    }

    function updateItemStatus(item, status, message) {
        const icon = item.querySelector('i');
        const statusText = item.querySelector('.status');
        if (status === 'success') {
            icon.className = 'fa-solid fa-check-circle';
            icon.style.color = '#16a34a';
            statusText.textContent = 'Uploaded!';
        } else {
            icon.className = 'fa-solid fa-circle-exclamation';
            icon.style.color = '#dc2626';
            statusText.textContent = message || 'Failed';
        }
    }

    function uploadFile(file) {
        const item = createUploadItem(file);
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        contentType: file.type,
                        base64: reader.result,
                        publicProfileUsername: publicUsername
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    updateItemStatus(item, 'success');
                } else {
                    updateItemStatus(item, 'error', data.message);
                }
            } catch (error) {
                updateItemStatus(item, 'error', 'Network error');
            }
        };
        reader.readAsDataURL(file);
    }
});
</script>

<%- include('partials/footer') %>