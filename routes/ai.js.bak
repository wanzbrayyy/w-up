const express = require('express');
const router = express.Router();
const File = require('../models/file');
const AiLog = require('../models/aiLog');
const { extractContent, summarizeText, searchInText } = require('../utils/fileProcessor');
const { translateText } = require('../utils/tr');
const { getDocsContent } = require('../utils/docsLoader'); 
const { r2, GetObjectCommand } = require('../utils/r2');
const auth = require('../middleware/auth');
const { 
    getUserProfile, 
    getStorageStats, 
    searchUsers, 
    getTeamData, 
    getActivityLog, 
    AI_SCHEMA_MAP 
} = require('../utils/aiHelpers');

const streamToString = (stream) =>
    new Promise((resolve, reject) => {
        const chunks = [];
        stream.on("data", (chunk) => chunks.push(chunk));
        stream.on("error", reject);
        stream.on("end", () => resolve(Buffer.concat(chunks).toString("utf8")));
    });

function maskPII(text) {
    return text
        .replace(/\b[\w\.-]+@[\w\.-]+\.\w{2,4}\b/g, '[EMAIL PROTECTED]')
        .replace(/\b(\+62|0)[0-9]{9,12}\b/g, '[PHONE PROTECTED]');
}

router.post('/chat', auth.protectApi, async (req, res) => {
    try {
        const { message, context } = req.body;
        const userId = req.user.id;
        const userRole = req.user.role;
        
        const userLang = context.language ? context.language.split('-')[0] : 'en';
        const englishQuery = await translateText(message, 'en', 'auto');
        const cleanMsg = englishQuery.toLowerCase().trim();
        
        let responseText = "";
        let action = null;

        // --- User Profile & Identity ---
        if (cleanMsg.includes('who am i') || cleanMsg.includes('my profile')) {
            const profile = await getUserProfile(userId);
            responseText = `Hello **${profile.username}**!\nRole: ${profile.role}\nPlan: ${profile.plan}\nStatus: ${profile.isVerified ? 'Verified' : 'Unverified'}`;
        }
        
        // --- Storage Stats ---
        else if (cleanMsg.includes('storage') || cleanMsg.includes('quota')) {
            const stats = await getStorageStats(userId);
            responseText = `**Storage Stats:**\nFiles: ${stats.files}\nUsed: **${stats.used}**\nLimit: **${stats.limit}**`;
        }
        
        // --- Activity Logs ---
        else if (cleanMsg.includes('activity') || cleanMsg.includes('login history')) {
            const logs = await getActivityLog(userId);
            responseText = `**Recent Activity:**\n${logs}`;
        }
        
        // --- Team Data ---
        else if (cleanMsg.includes('team') || cleanMsg.includes('members')) {
            const teamInfo = await getTeamData(userId);
            responseText = `**Team Information:**\n${teamInfo}`;
        }

        // --- Admin: User Search ---
        else if (cleanMsg.startsWith('search user')) {
            const query = cleanMsg.replace('search user', '').trim();
            const result = await searchUsers(query, userRole);
            responseText = `**Search Results:**\n${result}`;
        }

        // --- File Operations ---
        else if (cleanMsg.startsWith('read file') || cleanMsg.startsWith('open file')) {
            const filename = cleanMsg.replace(/^(read|open) file/, '').trim();
            const file = await File.findOne({ owner: userId, originalName: { $regex: filename, $options: 'i' }, deletedAt: null });

            if (!file) {
                responseText = `File "${filename}" not found.`;
            } else if (file.owner.toString() !== userId && !file.collaborators.includes(userId)) {
                responseText = "Permission Denied.";
            } else {
                try {
                    const content = await extractContent(file);
                    const snippet = content.length > 800 ? content.substring(0, 800) + "\n...(truncated)" : content;
                    responseText = `**${file.originalName}**:\n\`\`\`\n${snippet}\n\`\`\``;
                } catch (e) {
                    responseText = `Error reading file: ${e.message}`;
                }
            }
        }
        else if (cleanMsg.startsWith('summarize')) {
            const filename = cleanMsg.replace('summarize', '').trim();
            const file = await File.findOne({ owner: userId, originalName: { $regex: filename, $options: 'i' }, deletedAt: null });

            if (!file) {
                responseText = "File not found.";
            } else {
                try {
                    const content = await extractContent(file);
                    const summary = summarizeText(content);
                    responseText = `**Summary of ${file.originalName}:**\n\n${summary}`;
                } catch (e) {
                    responseText = "Could not generate summary.";
                }
            }
        }
        else if (cleanMsg.includes('search in file')) {
            const parts = cleanMsg.split(' in file ');
            if (parts.length === 2) {
                const query = parts[0].replace('search', '').trim();
                const filename = parts[1].trim();
                const file = await File.findOne({ owner: userId, originalName: { $regex: filename, $options: 'i' }, deletedAt: null });

                if (!file) {
                    responseText = "File not found.";
                } else {
                    try {
                        const content = await extractContent(file);
                        const results = searchInText(content, query);
                        responseText = results ? `**Found in ${file.originalName}:**\n\n${results}` : `No matches found.`;
                    } catch (e) {
                        responseText = "Search failed.";
                    }
                }
            } else {
                responseText = "Format: search [text] in file [filename]";
            }
        }
        
        // --- Navigation & Help ---
        else if (cleanMsg.includes('go to')) {
            const page = cleanMsg.includes('settings') ? '/profile' : '/dashboard';
            responseText = "Navigating...";
            action = { type: 'navigate', url: page };
        }
        else if (cleanMsg.includes('schema') || cleanMsg.includes('structure')) {
            responseText = `**System Schemas:**\nUser: ${AI_SCHEMA_MAP.User}\nFile: ${AI_SCHEMA_MAP.File}`;
        }
        else if (cleanMsg.includes('help')) {
            const { getDocsContent } = require('../utils/docsLoader');
            responseText = `**Knowledge Base:**\n${getDocsContent().substring(0, 300)}...\n\nCommands: Read file, Summarize, Search User (Admin), My Team, Activity Log.`;
        }
        else {
            responseText = `I can help you manage files, teams, and account. Try asking "Who am I" or "My Team".`;
        }

        const finalResponse = await translateText(responseText, userLang, 'en');
        const maskedResponse = maskPII(finalResponse);

        const log = new AiLog({
            user: userId,
            query: message,
            response: maskedResponse,
            ip: req.ip
        });
        await log.save();

        res.json({ response: maskedResponse, action, logId: log._id });

    } catch (error) {
        console.error(error);
        res.status(500).json({ response: "System Error." });
    }
});

router.post('/feedback/:id', auth.protectApi, async (req, res) => {
    try {
        const { type } = req.body; 
        await AiLog.findByIdAndUpdate(req.params.id, { feedback: type });
        res.json({ message: 'Feedback received' });
    } catch (e) {
        res.status(500).json({ message: 'Error' });
    }
});

module.exports = router;